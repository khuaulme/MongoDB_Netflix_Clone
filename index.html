<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link 
      rel="stylesheet" 
      type="text/css" 
      href="public/netflixclone.css" >
    <script src="https://kit.fontawesome.com/e1f93e03c9.js"></script>
    <title>NetflixClone</title>
  </head>
  <body>
    <header>
      <div class="row">
        <div class="col-3 view overlay">
          <img src="public/logo.svg" />  
        </div>

        <!-- Grid column -->

        <div class="col-9">
          <div class="row" id="box">
            <div class="col-11">
              <form onsubmit="searchMovies()" action="javascript:">
                <input
                  type="text"
                  onsubmit="searchMovies()"
                  autocomplete="off"
                  id="myInput"
                  class="form-control"
                  placeholder="Atlas Search Movies..."
                  aria-label="Search"
                  style="font-size: 2em; border: none"
                />
              </form>
            </div>
            <div class="col-1" style="text-align: center">
              <span
                ><i
                  class="fa fa-search"
                  aria-hidden="true"
                  onclick="searchMovies()"
                ></i
              ></span>
            </div>
          </div>
        </div>
        <br />
      </div>
    </header>

   <div class="grid-container" id="results">
     Movie Search Results
    </div>

    <script>
      async function searchMovies() {
        let searchString = document.getElementById("myInput").value;
        let txt = "";

        let webhook_url =
          "https://us-east-1.aws.webhooks.mongodb-realm.com/api/client/v2.0/app/netflixclone-hazaz/service/movies/incoming_webhook/getMovies";

        let url = webhook_url + "?arg=" + searchString;
        try {
          const response = await fetch(url);
          const movies = await response.json();

          console.log(movies);

          movies.forEach((movie) => {
            let title = movie.title;
            let plot = movie.plot;
            let year = movie.year["$numberInt"];
            let score = movie.score["$numberDouble"].toString().slice(0, 5);
            let poster = movie.poster ? movie.poster : "https://search-demos.s3.us-east-2.amazonaws.com/PosterNotFound.png";

            let plotWithHighlights = buildPlotHighlights(movie.highlights);

            txt += ` <div class="column">
                    <div class="MovieCard">
                        
                        <img class="img-poster" src=${poster} alt="poster" width="200">  
                        <b><h3>${title}</h3></b>
                        <h5><span class="color-gray">Score:</span> ${score} </h5>
                        <h5><span class="color-gray">Year:</span> ${year}</h5>
                        <p>${plotWithHighlights}</p>         
                    </div>
                </div>
                `;
          });

          document.getElementById("results").innerHTML = txt;
        
        } catch (error) {
          console.log("Whoopsie!", error);
        }
      }

      function buildPlotHighlights(highlights){

        console.log(highlights.length);
        let highlightString="";

        highlights.forEach(highlight =>{
          console.log(highlight.texts);
          let texts= highlight.texts;
          texts.forEach(text =>{
            if (text.type === 'hit')
              highlightString += `<span style="color:red"> ${text.value} </span>`
            else highlightString += text.value
          });
        });

        return highlightString;
      }
    </script>
  </body>
</html>
